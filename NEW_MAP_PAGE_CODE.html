<!-- NEW LEAFLET MAP VERSION - Paste this into Omeka admin panel -->

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
#mapFrame {
    height: 500px;
    width: 100%;
    border: 1px solid #ccc;
}
</style>

<script type="text/javascript">
var map;
var markers = {};

function initMap() {
    // Initialize Leaflet map centered on Norway
    map = L.map('mapFrame').setView([66.22821, 13.688965], 4);

    // Add OpenStreetMap tiles (free, no API key needed)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
    }).addTo(map);
}

function showLocation(title, lat, lng) {
    // Center map on location
    map.setView([lat, lng], 10);

    // Add or update marker
    if (markers[title]) {
        markers[title].openPopup();
    } else {
        var marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup('<strong>' + title + '</strong>').openPopup();
        markers[title] = marker;
    }

    window.scrollTo(0, 175);
}

function showAllLocations() {
    map.setView([66.22821, 13.688965], 4);
    window.scrollTo(0, 175);
}

// Initialize map when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
} else {
    initMap();
}
</script>

<p>Below are places mentioned on more than one occasion in the letters. Scroll to zoom in/out. Click and drag to move the map.</p>

<div id="mapFrame"></div>

<p><a href="javascript:showAllLocations()" style="display:none;" id="showall">Display all Locations</a></p>

<p>Focus on a single location by clicking on it below:</p>

<ul>
<?php
//Parse the location csv file and output the list.
$csvfile='/home/kmlawson/huginn.net/shoebox/map/locations.csv';

$fileasarray=file($csvfile);
if (!$fileasarray) {
    exit('Location file could not be found or read.');
}
sort($fileasarray);
foreach ($fileasarray as $locationdata)
{
    $row=explode(',',$locationdata);
    $lat = trim($row[2]);
    $lng = trim($row[3]);
    ?>
<li><strong><a href="javascript:showLocation('<?php echo addslashes($row[0]); ?>', <?php echo $lat; ?>, <?php echo $lng; ?>)" onclick="document.getElementById('showall').style.display='block';"><?php echo htmlspecialchars($row[0]); ?></a></strong> - <?php echo htmlspecialchars($row[1]); ?> (<a href="https://huginn.net/shoebox/letters/items/browse?tags=<?php echo urlencode($row[0]); ?>">Items</a>)</li>
<?php
}
?>
</ul>
