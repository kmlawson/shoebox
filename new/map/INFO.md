# Letters Map

## Overview

This interactive map visualizes correspondence routes between Norway and America from the Norwegian Letters collection (1911-1956). The map displays curved lines connecting locations, with line thickness and color indicating the volume of correspondence between location pairs.

## Features

### Visual Elements

- **Curved Lines**: Connect location pairs with varying curvature to reduce overlap
- **Line Color & Thickness**: Indicates correspondence volume
  - Red (thick): 50+ letters
  - Orange: 20-49 letters
  - Yellow-orange: 10-19 letters
  - Blue: 5-9 letters
  - Gray (thin): 1-4 letters
- **Location Markers**: Dark circles marking each location
- **Interactive Popups**: Click lines or markers to see details

### Filtering Controls

The map includes four filter sliders:

1. **Min # letters**: Set minimum correspondence volume (default: 1)
2. **Max # letters**: Set maximum correspondence volume (default: 70)
3. **After year**: Show only letters written after this year (default: 1911)
4. **Before year**: Show only letters written before this year (default: 2000)

**Dynamic Line Updates**: When you adjust the year filters, lines automatically:
- Recalculate their thickness and color based on filtered letter count
- Update popup information to show filtered vs. total counts
- Hide completely if no letters match the criteria

### Popup Information

**Line Popups** (click on a line):
- Location pair (e.g., "Dell Rapids ↔ Stjørdal")
- Number of letters in filtered range
- List of letter IDs (clickable links to individual letters)
- "View all X letters" link (filters main site to show just these letters)

**Marker Popups** (click on a location):
- Location name
- Total number of letters from/to that location
- List of all letter IDs (clickable links)
- "View all letters" link

## Data Files

### pairs.csv

Generated by `../generate-pairs.py`, contains:

```
Location1,Lat1,Lon1,Country1,Location2,Lat2,Lon2,Country2,Count,LetterIDs
Dell Rapids,43.8261,-96.7062,United States,Stjørdal,63.4697,10.9131,Norway,67,1;9;19;...
```

- **Bidirectional pairs**: Dell Rapids→Stjørdal and Stjørdal→Dell Rapids treated as one pair
- **Letter IDs**: Semicolon-delimited to avoid CSV quoting issues
- **25 unique pairs**, 188 total letter connections

### letters.json

Referenced from parent directory (`../letters.json`) for year filtering. Contains full letter metadata including dates.

### locations.csv

Used by generate-pairs.py, contains coordinates for all locations mentioned in letters.

## Basemap Configuration

### Current Basemap: CartoDB Positron

The map currently uses **CartoDB Positron** - a free, clean, minimal light-themed basemap that doesn't compete visually with the colored correspondence lines.

```javascript
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 20
}).addTo(map);
```

**Pros**:
- Clean, minimal design
- Free, no API key required
- High zoom level support (up to 20)
- Well-maintained by CARTO

### Alternative Free Basemaps

If CartoDB Positron becomes unavailable, here are free alternatives that require no API keys:

#### 1. OpenStreetMap Standard (Mapnik)

The classic OSM style - detailed streets and labels.

```javascript
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  maxZoom: 19
}).addTo(map);
```

#### 2. OpenTopoMap (Terrain)

Topographic style with terrain shading - good for showing the Atlantic crossing.

```javascript
L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
  attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
  maxZoom: 17
}).addTo(map);
```

#### 3. CartoDB Dark Matter

Dark theme variant from CARTO - good for high contrast.

```javascript
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);
```

#### 4. CartoDB Voyager

Balanced style with subtle terrain features.

```javascript
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);
```

### How to Change the Basemap

To switch basemaps, edit `map.html` around **line 244**:

1. Find the existing `L.tileLayer()` call
2. Replace with one of the alternatives above
3. Update the attribution text
4. Adjust maxZoom if needed

**Example**:

```javascript
// OLD (CartoDB Positron)
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 20
}).addTo(map);

// NEW (OpenStreetMap Standard)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  maxZoom: 19
}).addTo(map);
```

## Technical Details

### Curved Line Algorithm

Lines use **quadratic Bezier curves** to create smooth arcs:

```javascript
// Bezier formula: B(t) = (1-t)² * P0 + 2(1-t)t * P1 + t² * P2
const lat = t1 * t1 * lat1 + 2 * t1 * t * controlLat + t * t * lat2;
const lon = t1 * t1 * lon1 + 2 * t1 * t * controlLon + t * t * lon2;
```

- **Curve variation**: 5 different curvature strengths (10%, 18%, 26%, 34%, 42%) alternating direction
- **50 points** per curve for smooth rendering
- **Invisible wider line**: 10px wider than visible line for easier clicking

### Three-Pass Rendering

To ensure markers appear on top:

1. **First pass**: Collect all location and line data from CSV
2. **Second pass**: Render all curved lines
3. **Third pass**: Add location markers on top

### Year Filtering Logic

When year filters are adjusted:

1. Count how many letters from each pair fall within the year range
2. Recalculate line style (color/thickness) based on filtered count
3. Update popup to show "20 (of 67 total)" if filtered
4. Hide lines with zero matching letters
5. Update "View letters" links to only filtered letters

## Files Structure

```
new/map/
├── map.html          # Main map page (HTML, CSS, JavaScript)
├── pairs.csv         # Location pair data with letter IDs
└── INFO.md           # This documentation file

new/
├── letters.json      # Full letter data (referenced by map)
├── generate-pairs.py # Script to generate pairs.csv
├── locations.csv     # Location coordinates
└── index.html        # Main site (links to map)
```

## Browser Compatibility

- Modern browsers with JavaScript enabled
- Leaflet 1.9.4 (loaded from CDN)
- No build step required
- Works on mobile devices

## Maintenance Notes

- **No API keys required** for current or suggested alternative basemaps
- **HTTPS compatible** - all tile URLs use HTTPS
- **Self-contained** - all code in single HTML file
- **Performance**: Handles 25 pairs efficiently; filters respond instantly

## Credits

- **Map Library**: Leaflet 1.9.4
- **Basemap**: CartoDB Positron (or alternatives)
- **Tile Data**: © OpenStreetMap contributors
- **Correspondence Data**: A Shoebox of Norwegian Letters collection (1911-1956)
